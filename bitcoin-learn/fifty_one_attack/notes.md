# 51% attack

A “51% attack” is a type of attack that, between others, would allow a malicious attacker (i.e., one or several nodes) to double spend an amount of bitcoin. Let me explain. (For now, don’t pay attention to the “51%”, we’ll come back to it later).

Bitcoin considers that the “true” blockchain is the one that contains the most blocks (more precisely, the most proof of work (which, I would say, is calculated by summing the mining difficulty of each block in a chain).

Given that, when a node builds a new block (let’s say block n + 1, before any other node, of course), it creates the longest existing blockchain which, when its broadcasted to the other nodes is adopted as the new “true” blockchain. At that point, all nodes stop searching for a nonce to build block n + 1 and they switch to searching for a nonce that’s valid to build block n + 2.

As described in the above paragraph, most times, when a new (longer) blockchain version is broadcasted, it’s only one block higher: more transactions are confirmed (confirmed just once, though) and that’s it.
Let’s now introduce the “51% attack” and explain how it allows double spending via a “reorg”. Let’s say a group of nodes (e.g., forming a mining pool) collude to make a transaction with a “merchant”, get what they paid for, but also get the bitcoins they sent to the merchant back to them.
- They send the transaction to the mempool.
- The merchant waits for the transaction to be included in a block, and possibly, if they are cautious, for more blocks to be built after that block. Once they deem the transaction sufficiently confirmed (i.e., sufficiently irreversible), they send whatever the attacker paid for.
- In the meantime, as soon as the block containing the transaction was built on the “true” chain, the attacker forks the true chain: 
  - In the nodes of the malicious mining pool, it takes the block in question and alters the transaction so that instead of sending the bitcoins to the merchant, the transaction sends them to the attacker themself.
  - From that point, the attacker mining pool stops accepting longer chains as the truth if they come from (honest) nodes outside that mining pool and exclusively mines its altered forked blockchain. Its goal is to build blocks fast enough to make this parallel, altered chain longer than the true one – as we will see later, this is the most difficult part of the operation. Also, the attacker’s mining pool doesn’t broadcast its advancements on the forked chain outside the mining pool as long as it didn’t reach that goal (it would be useless since it wouldn’t be deemed true sas its shorter and I guess broadcasting an altered chain could raise alarms and make the Bitcoin network take defensive actions before it’s too late).
  - If the attacker manages to create a forked chain whose height exceeds the height of the true chain, it broadcasts it to all nodes which deem it as true. The blocks of the true chain that were mined since the transaction (including the one containing the transaction) are replaced by the blocks at the same height from the altered chain. That’s what’s called a [reorg](https://learnmeabitcoin.com/technical/blockchain/chain-reorganisation/).
  - The merchant sees that the bitcoins it once had received have vanished and that the underlying transaction was altered. And that’s it. The merchant was stolen and the attacker is free to spend the bitcoins in question a second (the infamous double spending).

Now, let’s look at the maths of this trick as presented in the white paper. Satoshi proposes the following formula.

Given 
- $p =$ probability an honest node finds the next block
- $q =$ probability the attacker finds the next block
- $q_z =$ probability the attacker will ever catch up from $z$ blocks behind

$q_z = 1$ if $p ≤ q$

$q_z = (q / p)^z$ if $p > q$

Here’s my rephrasing of it: 
- $q_z$ is the probability the attacker will ever produce a longer chain. “ever” is important here, we’ll come back to it. 
- $q$ is a probability that is directly proportional to the hashrate (hashes/sec) of the attacker which is the speed at which the altered chain is built.
- $p$ is a probability that is directly proportional to the hashrate (hashes/sec) of the honest nodes (cumulative across all honest nodes) which is the speed at which the true chain is built.
- We can assume that $p = 1 - q$ which means that the attacker’s full hashrate is deployed on the network previous to the attack (1 being the network’s hashrate). But it’s not a rule since the attacker could mobilize more (or less, but that would make little sense) hashing power during the attack than what they deployed on the network previously.
- For my understanding, I’ve approached q/p as the amount of hashrate the attacker possesses expressed as a share of the amount of hashrate under honest control. For instance, with $p = 0.7$ and $p = 0.3$, $q/p = 0.43$, which means that the average chain building speed of the attacker equals 43% of the one of the “true” chain. Interpreted as a share, this quotient could lead to the conclusion that the attack will fail. But let’s not forget that q, p, and their quotient are probabilities. Hence, $q/p = 0.43$ means that there is a 43% chance for the attacker to add 1 block to its altered chain faster than the honest nodes on their chain. To succeed, the attacker must repeat this feat z times to catch up, plus 1 additional time to produce the longest chain. Hence, each increment of z makes the attack exponentially more difficult. Satoshi focuses on “catching up” whereas the attacker would need to surpass the “true” chain to succeed. Hence, I propose to use this instead: $az = (q/p)^(z+1)$, with az being the probability the attacker will ever surpass the “true” chain from z blocks behind. Going back to our example, with $z = 1$, we get a $0.3/0.7^(1+1) = 18\%$ chance for the attacker to succeed.
- The formula states that when p = q, the attacker has a 100% chance of succeeding which I found counterintuitive. The reasoning behind this goes back to the “ever” I highlighted earlier and to the fact that this process (this race between two chains) corresponds to a random binomial walk. With equal hashing speeds, the “random walk” the two chains follow is symmetrical and, given an infinite amount of time, there’s a 100% chance that, at some point, randomness will grant the altered chain a 1-block overreach. Mathematically, it is considered that a value following a symmetric random walk will take all the possible values an infinite number of times, if given an infinite amount of time: it’s what I would call total, unskewed randomness.

Further down, Satoshi proposes a more complex and more operational formula to determine the risk the attacker catches up (not surpasses). It is more accurate because the first formula takes $z$ – the number of blocks that miss from the altered chain to match the “true” one – as a given while in reality $z$ is unknown (only the attacker knows it). What we know is the number of blocks mined on the true chain from (i) the moment the one containing the transaction was mined (included) to (ii) the moment the merchant delivers what the attacker paid for. During that period, the attacker has mined a number of blocks (k) that follows a Poisson law (I recommend looking at the formula of this law [here](https://en.wikipedia.org/wiki/Poisson_distribution) to better understand Satoshi’s formula). The expected number of blocks mined by the attacker is $z * q / p$ which is [the number of blocks mined by honest blocks] times [the amount of hashrate the attacker has, expressed as a share of the amount the honest nodes collectively have] (think “pro rata” chain building speed). That’s the left part of the product inside the summation. Since we can only estimate k, the most accurate way to measure the probability an attacker catches up consists in, for all k, multiplying the Poisson density for that k value (the probability that the attacker has mined k blocks) by the probability it catches up from $z - k$ blocks behind.

As explained above, Satoshi focuses on catching up the true chain, but the attacker needs to surpass it to trigger a reorg and succeed. So, a $+ 1$ needs to be added to the $z - k$ exponent to measure the probability of success.

And why is this attack called a “51% attack”? You might have told yourself that owning 51% of the network’s hashrate is not necessary to conduct it, and that’s correct. But as soon as the attacker has >=51% (>=50% actually, as explained earlier based on the random walk mathematics), it has a 100% chance of success. 

Double spending is one (probably the most feared) of the consequences of a 51% attack, but poses more threats that I won’t expand on. A quick overview is proposed [here](https://www.investopedia.com/terms/1/51-attack.asp).